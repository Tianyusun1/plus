# File: configs/default.yaml (V10.0: Text-to-Gestalt Enhanced Configuration)

model:
  # =============================================================================
  # Text Encoder
  # =============================================================================
  bert_path: "/home/610-sty/huggingface/bert-base-chinese"
  hidden_size: 768
  
  # =============================================================================
  # Layout Decoder
  # =============================================================================
  bb_size: 128            
  decoder_layers: 6
  decoder_heads: 8
  dropout: 0.3
  
  # =============================================================================
  # Output Classes
  # =============================================================================
  num_classes: 9  # 9个元素类别 (mountain, water, people, tree, building, bridge, flower, bird, animal)
  
  # =============================================================================
  # CVAE Parameters
  # =============================================================================
  latent_dim: 64          # 隐变量维度，控制布局多样性
  
  # =============================================================================
  # [V10.0 UPDATED] Loss Weights - Supervised Training Stage
  # =============================================================================
  # 基础几何损失
  reg_loss_weight: 1.0      # 坐标回归损失 (Smooth L1)
  iou_loss_weight: 1.0      # IoU损失
  area_loss_weight: 1.0     # 面积损失
  
  # 高级布局损失
  relation_loss_weight: 5.0  # 空间关系损失 (基于KG的Above/Below/Inside等)
  overlap_loss_weight: 3.0   # 重叠惩罚
  size_loss_weight: 2.0      # 尺寸先验损失
  
  # 审美和一致性损失
  alignment_loss_weight: 0.0    # 对齐损失 (暂时关闭，避免过度约束)
  balance_loss_weight: 0.0      # 平衡损失 (暂时关闭)
  clustering_loss_weight: 1.0   # 聚类损失 (同类物体应接近)
  consistency_loss_weight: 2.0  # 文本-布局一致性损失
  
  # =============================================================================
  # [NEW V10.0] Visual Gestalt Loss Weight
  # =============================================================================
  # 这是总态势损失的权重，内部会细分为 pixel/semantic/smooth 三部分
  # 细分权重由 trainers/loss.py 中的 get_gestalt_loss_weights() 动态控制
  gestalt_loss_weight: 2.0  
  
  # 注意：gestalt_reg_loss_weight 已废弃，现在统一用 gestalt_loss_weight
  
  # =============================================================================
  # Inference Parameters
  # =============================================================================
  max_elements: 30  # 推理时最多生成的元素数量
  
  # =============================================================================
  # Data Paths
  # =============================================================================
  xlsx_path: "/home/610-sty/layout2paint/dataset/6800poems.xlsx"
  images_dir: "/home/610-sty/layout2paint/dataset/6800"
  labels_dir: "/home/610-sty/layout2paint/dataset/6800/JPEGImages-pre_new_txt"
  max_layout_length: 30   # Dataset中单个样本最多包含的元素数
  max_text_length: 64     # 诗歌文本最大token长度

# =============================================================================
# Training Configuration
# =============================================================================
training:
  # =============================================================================
  # Stage 1: Supervised Pre-training (文本→布局+态势的端到端学习)
  # =============================================================================
  batch_size: 128         # 根据显存调整 (32GB可用128, 16GB建议64)
  epochs: 100             # [V10.0 建议] 让语义先验充分学习
  learning_rate: 0.0001   # 基础学习率 (AdamW)
  warmup_steps: 1000      # 线性warmup步数
  
  # =============================================================================
  # [NEW V10.0] Gestalt Learning Strategy
  # =============================================================================
  # 控制态势损失权重的动态调整策略
  # - 'progressive': 渐进式 (Epoch 0-10: 主要学像素, 10-30: 加强语义, 30+: 降低像素依赖)
  # - 'fixed': 固定权重 (始终使用 pixel=1.0, semantic=2.0, smooth=0.3)
  gestalt_strategy: 'progressive'
  
  # =============================================================================
  # Logging & Saving
  # =============================================================================
  save_every: 50          # 每50个epoch保存一次checkpoint
  output_dir: "./outputs/v10_text_to_gestalt"  # [V10.0 建议] 新输出目录
  log_steps: 10           # 每10步打印一次训练日志
  visualize_every: 5      # 每5个epoch生成一次推理可视化
  
  # =============================================================================
  # Stage 2: RL Fine-tuning Configuration (可选)
  # =============================================================================
  rl_epochs: 400          
  
  # [CRITICAL] RL学习率必须远低于监督训练，避免破坏预训练权重
  rl_learning_rate: 2e-6  
  
  # =============================================================================
  # [V10.0 UPDATED] RL Reward Weights
  # =============================================================================
  # 注意：RL阶段不直接优化态势，而是通过奖励间接引导
  reward_weights:
    # 基础对齐奖励
    iou: 2.0              # IoU奖励
    relation: 4.0         # 空间关系正确性奖励
    
    # 物理和审美奖励
    physics: 6.0          # 物理可行性 (防止"山"无限大等)
    alignment: 4.0        # 对齐度奖励
    heatmap_size: 2.5     # 尺寸与热力图匹配度
    
    # 惩罚项
    dispersion: 6.0       # 分散度奖励 (鼓励元素散开)
    overlap: -8.0         # 重叠惩罚 (负数表示惩罚)
    boundary: -3.0        # 边界越界惩罚
    
    # =============================================================================
    # [NEW V10.0] 态势质量奖励 (可选，实验性功能)
    # =============================================================================
    # 在RL阶段评估生成的态势是否符合语义先验
    # 例如：检查"水"的flow是否>0，"山"的flow是否<0
    gestalt_semantic: 1.0  # 态势语义一致性奖励

# =============================================================================
# Inference Configuration
# =============================================================================
inference:
  max_output_length: 30   # 推理时最多生成的布局元素数

# =============================================================================
# [NEW V10.0] Advanced Configuration (高级用户调整)
# =============================================================================
advanced:
  # 语义先验自定义 (如果要覆盖 trainers/loss.py 中的默认值)
  # 格式: {class_id: [flow_mean, flow_std, rotation_mean, rotation_std, bias_weight]}
  custom_semantic_priors:
    # 例如：如果你的数据集中"水"通常是静止的，可以覆盖默认值
    # 3: [0.2, 0.25, 0.0, 0.5, 0.6]  # 水的flow从0.5降低到0.2
    # 留空表示使用代码中的默认值
  
  # 课程学习自定义
  curriculum:
    # KL散度权重目标值
    target_kl_weight: 0.005
    # KL annealing开始的epoch
    kl_start_epoch: 5
    # KL annealing持续的epoch数
    kl_duration: 150
    
    # 关系损失→回归损失的权重转移
    relation_to_reg_start_epoch: 50
    relation_to_reg_duration: 100
  
  # 数据增强 (在dataset.py中实现)
  augmentation:
    # 水平翻转概率
    flip_prob: 0.5
    # 坐标抖动范围
    jitter_range: 0.02
    # 位置引导信号随机偏移
    location_shift_prob: 0.7