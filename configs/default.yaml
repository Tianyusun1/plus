# File: configs/default.yaml (V12.0: RL Gestalt Enhanced Configuration)

model:
  # =============================================================================
  # Text Encoder
  # =============================================================================
  bert_path: "/home/610-sty/huggingface/bert-base-chinese"
  hidden_size: 768
  
  # =============================================================================
  # Layout Decoder
  # =============================================================================
  bb_size: 128            
  decoder_layers: 6
  decoder_heads: 8
  dropout: 0.3
  
  # =============================================================================
  # Output Classes
  # =============================================================================
  num_classes: 9  # 9个元素类别 (mountain, water, people, tree, building, bridge, flower, bird, animal)
  
  # =============================================================================
  # CVAE Parameters
  # =============================================================================
  latent_dim: 64          # 隐变量维度，控制布局多样性
  
  # =============================================================================
  # [V10.0 UPDATED] Loss Weights - Supervised Training Stage
  # =============================================================================
  # 基础几何损失
  reg_loss_weight: 1.0      # 坐标回归损失 (Smooth L1)
  iou_loss_weight: 1.0      # IoU损失
  area_loss_weight: 1.0     # 面积损失
  
  # 高级布局损失
  relation_loss_weight: 5.0  # 空间关系损失 (基于KG的Above/Below/Inside等)
  overlap_loss_weight: 3.0   # 重叠惩罚
  size_loss_weight: 2.0      # 尺寸先验损失
  
  # 审美和一致性损失
  alignment_loss_weight: 0.0    # 对齐损失 (暂时关闭，避免过度约束)
  balance_loss_weight: 0.0      # 平衡损失 (暂时关闭)
  clustering_loss_weight: 1.0   # 聚类损失 (同类物体应接近)
  consistency_loss_weight: 2.0  # 文本-布局一致性损失
  
  # =============================================================================
  # [NEW V10.0] Visual Gestalt Loss Weight
  # =============================================================================
  # 这是总态势损失的权重，内部会细分为 pixel/semantic/smooth 三部分
  # 细分权重由 trainers/loss.py 中的 get_gestalt_loss_weights() 动态控制
  gestalt_loss_weight: 2.0  
  
  # 注意：gestalt_reg_loss_weight 已废弃，现在统一用 gestalt_loss_weight
  
  # =============================================================================
  # Inference Parameters
  # =============================================================================
  max_elements: 30  # 推理时最多生成的元素数量
  
  # =============================================================================
  # Data Paths
  # =============================================================================
  xlsx_path: "/home/610-sty/layout2paint/dataset/6800poems.xlsx"
  images_dir: "/home/610-sty/layout2paint/dataset/6800"
  labels_dir: "/home/610-sty/layout2paint/dataset/6800/JPEGImages-pre_new_txt"
  max_layout_length: 30   # Dataset中单个样本最多包含的元素数
  max_text_length: 64     # 诗歌文本最大token长度

# =============================================================================
# Training Configuration
# =============================================================================
training:
  # =============================================================================
  # Stage 1: Supervised Pre-training (文本→布局+态势的端到端学习)
  # =============================================================================
  batch_size: 128         # 根据显存调整 (32GB可用128, 16GB建议64)
  epochs: 100             # [V10.0 建议] 让语义先验充分学习
  learning_rate: 0.0001   # 基础学习率 (AdamW)
  warmup_steps: 1000      # 线性warmup步数
  
  # =============================================================================
  # [NEW V10.0] Gestalt Learning Strategy
  # =============================================================================
  # 控制态势损失权重的动态调整策略
  # - 'progressive': 渐进式 (Epoch 0-10: 主要学像素, 10-30: 加强语义, 30+: 降低像素依赖)
  # - 'fixed': 固定权重 (始终使用 pixel=1.0, semantic=2.0, smooth=0.3)
  gestalt_strategy: 'progressive'
  
  # =============================================================================
  # Logging & Saving
  # =============================================================================
  save_every: 50          # 每50个epoch保存一次checkpoint
  output_dir: "./outputs/v12_gestalt_rl_enhanced"  # [V12.0 建议] 新输出目录
  log_steps: 10           # 每10步打印一次训练日志
  visualize_every: 5      # 每5个epoch生成一次推理可视化
  
  # =============================================================================
  # Stage 2: RL Fine-tuning Configuration
  # =============================================================================
  rl_epochs: 400          
  
  # [CRITICAL] RL学习率必须远低于监督训练，避免破坏预训练权重
  rl_learning_rate: 2e-6  
  
  # =============================================================================
  # [V12.0 NEW] RL Gestalt Constraint Weights
  # =============================================================================
  # 这些权重控制RL阶段的势态物理约束奖励
  # 目的：防止监督学习的势态在RL探索中退化
  
  # 势态物理匹配奖励 (核心!)
  # 确保类别与势态特征匹配，例如water的flow>0.5, mountain的flow<-0.5
  w_gestalt_physics: 8.0
  
  # 势态空间平滑奖励
  # 鼓励相邻物体的势态连续变化 (如连续山脉的rotation应逐渐过渡)
  w_gestalt_smooth: 3.0
  
  # 势态极值惩罚
  # 防止态势参数爆炸到边界值 (bias/rotation超过±0.95)
  w_gestalt_extreme: 5.0
  
  # 势态监督损失权重 (辅助)
  # 在RL训练中每5步混合一次监督损失，防止势态漂移
  w_gestalt_sup: 0.3
  
  # =============================================================================
  # [V12.0 UPDATED] RL Reward Weights (布局奖励)
  # =============================================================================
  reward_weights:
    # 基础对齐奖励
    iou: 2.0              # IoU奖励
    relation: 4.0         # 空间关系正确性奖励
    
    # 物理和审美奖励
    physics: 6.0          # 物理可行性 (防止"山"无限大等)
    alignment: 4.0        # 对齐度奖励
    heatmap_size: 2.5     # 尺寸与热力图匹配度
    
    # 惩罚项
    dispersion: 7.0       # 分散度奖励 (鼓励元素散开) [V12.0提升]
    overlap: -15.0        # 重叠惩罚 (负数表示惩罚) [V12.0加强]
    boundary: -3.0        # 边界越界惩罚
    
    # 重力平衡系统
    balance: 5.0          # 重力沉底 (Target Y=0.75, 物体向下/留白在上)
    center: 1.5           # 水平居中倾向
    
    # =============================================================================
    # [DEPRECATED] 以下参数已合并到 w_gestalt_physics
    # =============================================================================
    # gestalt_semantic: 不再需要，已由w_gestalt_physics替代

# =============================================================================
# Inference Configuration
# =============================================================================
inference:
  max_output_length: 30   # 推理时最多生成的布局元素数

# =============================================================================
# [V12.0 UPDATED] Advanced Configuration
# =============================================================================
advanced:
  # =============================================================================
  # [NEW V12.0] 态势先验自定义 (Gestalt Priors Override)
  # =============================================================================
  # 如果数据集有特殊性,可以覆盖 trainers/rl_trainer.py 中的 GESTALT_PRIORS
  # 格式: {class_id: {param: [target, tolerance]}}
  # 留空表示使用代码中的默认值
  custom_gestalt_priors:
    # 示例: 如果你的数据集中"水"通常是静止的，可以调整先验
    # 3:  # Water
    #   flow: [0.3, 0.25]      # 降低流动性目标值 (默认是0.6)
    #   bias_x: [0.0, 0.4]     # 收紧偏移容差
    # 
    # 5:  # Tree
    #   rotation: [0.3, 0.5]   # 增加倾斜度
    
  # =============================================================================
  # 语义先验自定义 (用于监督训练阶段)
  # =============================================================================
  # 格式: {class_id: [flow_mean, flow_std, rotation_mean, rotation_std, bias_weight]}
  custom_semantic_priors:
    # 留空表示使用 trainers/loss.py 中的默认值
  
  # =============================================================================
  # 课程学习自定义
  # =============================================================================
  curriculum:
    # KL散度权重目标值
    target_kl_weight: 0.005
    # KL annealing开始的epoch
    kl_start_epoch: 5
    # KL annealing持续的epoch数
    kl_duration: 150
    
    # 关系损失→回归损失的权重转移
    relation_to_reg_start_epoch: 50
    relation_to_reg_duration: 100
  
  # =============================================================================
  # 数据增强
  # =============================================================================
  augmentation:
    # 水平翻转概率
    flip_prob: 0.5
    # 坐标抖动范围
    jitter_range: 0.02
    # 位置引导信号随机偏移
    location_shift_prob: 0.7
    
  # =============================================================================
  # [NEW V12.0] RL训练调试选项
  # =============================================================================
  rl_debug:
    # 是否在训练时输出详细的势态统计
    log_gestalt_stats: true
    # 每N步检查一次势态分布
    gestalt_check_interval: 100
    # 是否保存势态变化轨迹图
    save_gestalt_trajectory: true